#!/bin/bash

# Gets cpu usage of worker nodes and gives ip of least used one

# The workerlist is generated by fortran task in basics

function proc() {
    echo "$( (ssh -o ConnectTimeout=3 $USER@$1 /usr/local/bin/procsys.sh) || echo 200) $1"
}

function callproc() {
    # read workerlist
    while IFS="" read -r p || [ -n "$p" ]
    do
        proc "$p" &
    done < /usr/local/lib/workerlist

    # wait for ssh to finish
    sleep 5
}

# sort -n to sort numbers
# tee /dev/tty is to also print values: | tee /dev/tty  |
# get first entry, second word = host ip

if [[ "$1" == "--all" ]]; then
    callproc | sort -n
else
    callproc | sort -n | head -n 1 | cut -d ' ' -f 2
fi
