#!/bin/bash

# Gets cpu usage of worker nodes and gives ip of least used one

function proc() {
    echo "$( (ssh -o ConnectTimeout=2 $USER@$1 cat /tmp/proccpu) || echo 200) $1"
}

function callproc() {
    # read workerlist
    # call proc as background task so ssh can happen in parallel
    while IFS="" read -r p || [ -n "$p" ]
    do
        proc "$p" &
    done < /usr/local/lib/workerlist

    # wait for ssh to finish
    sleep 4
}

# sort -n to sort numbers
# tee /dev/tty is to also print values: | tee /dev/tty  |
# get first entry, second word = host ip

if [[ "$1" == "--all" ]]; then
    # asume for printing, so add '%'
    callproc | sort -n | awk '{ print $1 "%\t" $2 }'
else
    # return least used cpu
    callproc | sort -n | head -n 1 | cut -d ' ' -f 2
fi
